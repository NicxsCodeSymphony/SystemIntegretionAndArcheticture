<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/page.css">
</head>
<body>
   
    <div class="page-container">
        <div class="page-header">
            <div class="logo"><h3>Campus <span>Connect</span></h3></div>
            <div class="menu">
                <ul>
                    <li><a href="userPage.html">Home</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="friends.html">Find Friends</a></li>
                    <li style="cursor: pointer;" id="notification">Notification</li>
                    <li></li>
                </ul>
            </div>
            <div class="name"><h3 id="name"></h3><button style="margin-left: 10px;" id="logout">Logout</button></div>
        </div>

        <div class="content">
            <div></div>
            
            <div class="feeds">
                <div class="post">
                    <div class="post-heading"><img src="" alt=""> <h4>What's on your mind, <span id="anotherName"></span>?</h4></div>
                    <hr>
                    <div class="post-footer"><i class="fa-regular fa-image"></i><p>Photo</p></div>
                </div>

                <div class="feeds-content">
                    
                </div>

            </div>
            <div class="friend-section"></div>
        </div>

    </div>

    <template class="friendList">
        <div class="friends">
            <h4 class="friendsName"></h4>
        </div>
    </template>

    <div class="add-post">
        <div class="post-heading">
            <h1>Create Post</h1>
            <button id="close">X</button>
        </div>
        <div class="post-images">
            <img class="avatar" src="assets/nico.jpg" alt="">
            <div class="poster-infos">
                <p class="usernames"></p>
                <p class="poster-names"></p>
            </div><br>
        </div>
        <div class="input-post">
            <textarea id="get-text" placeholder="What's on your mind?"></textarea>
        </div>
        <div class="additional-post">
            <h3>Add to your post</h3>
        </div>

       <div class="post-btn-container">
        <button id="create-post">Create Post</button>
       </div>
    </div>

    <div style="height: 100vh; width: 100%; position: fixed; top: 0; background: #fff; display: none" class="modal" id="notificationModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="notification"></div>
        </div>
    </div>
    

    <template class="poster-template">
        <div class="post-container">
            <input type="hidden" id="userId">
            <input type="hidden" id="postId">
            <div class="poster-image">
                <img class="avatar" src="" alt="">
                <div class="poster-info">
                    <p class="username"></p>
                    <p class="poster-name"><span class=""></span></p>
                </div>
            </div>
            <div class="caption"><p class="display-caption"></p></div>
            <!-- <div class="post-image"><img src="assets/sample.png" alt=""></div> -->
            <div class="interaction"><i class="fa-regular fa-heart"></i><i class="fa-regular fa-comment"></i></div>
            <hr>
            <div class="comment">
                <!-- <img style="width: 10%; height: 50%; border-radius: 50%;" id="commentAvatar"  src="" alt=""> -->
                <input type="text" name="" id="" placeholder="Write your comment . . ."/>
                <button id="comment-btn">Send</button>
            </div>
        </div>
    </template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"></script>
    <script src="js/main.js"></script>
    <script>
     $(document).ready(function() {
    var id = localStorage.getItem("id");
    var name = localStorage.getItem("name");
    var username = localStorage.getItem('username');
    var image = localStorage.getItem('image');
    if (!name) {    
        window.location.href = "index.html"; 
    } else {
        var firstName = name.split(" ").slice(0, -1).join(" ");
        document.getElementById("name").textContent = firstName;
        document.getElementById("anotherName").textContent = firstName;
        document.querySelector(".poster-names").textContent = name;
        document.querySelector(".usernames").textContent = "@" + username;

    }

    


    $.ajax({
        url: "php/fetchFriends.php",
        type: "GET",
        success: function(data) {
            let people = JSON.parse(data);
            let template = document.querySelector('.friendList');
            let container = document.querySelector('.friend-section');

            people.forEach(person => {
                let clone = template.content.cloneNode(true);
                clone.querySelector('.friendsName').textContent = person.name;
                container.appendChild(clone);
            });
        },
        error: function() {
            alert("Error fetching people data.");
        }
    });

    document.getElementById("create-post").addEventListener('click', ()=>{
        
        $.ajax({
    url: "php/post.php", 
    type: "POST",
    data: {
        id: id,
        imagePost: "sample",
        caption: document.getElementById('get-text').value
    },
    success: function(data) {
        let result = JSON.parse(data);
        if (result.res === "success") {
            alert("Post added successfully.");
            window.location.reload();
        } else {
            alert(result.message);
        }
    },
    error: function() {
        alert("Error adding post.");
    }
});




})

var userId = localStorage.getItem("id");

    // Function to fetch and display friend requests
    function fetchFriendRequests() {
    $.ajax({
        url: "php/friendRequest.php",
        type: "POST",
        data: {
            userId: userId
        },
        success: function(data) {
            let requests = JSON.parse(data);
            let notificationContainer = document.querySelector('.notification');
            notificationContainer.innerHTML = '';

            requests.forEach(request => {
                if (request.status === 'Pending') {
                    let requestDiv = document.createElement('div');
                    requestDiv.classList.add('request');

                    let senderId = request.id;
                    let senderIdD = request.sender_id;
                    let receiverId = request.receiver_id;
                    let senderName = request.sender_name;

                    let acceptButton = document.createElement('button');
                    acceptButton.textContent = 'Accept';
                    acceptButton.addEventListener('click', function() {
                        // Handle accepting friend request
                        acceptFriendRequest(senderId, receiverId,senderIdD);
                    });

                    let rejectButton = document.createElement('button');
                    rejectButton.textContent = 'Reject';
                    rejectButton.addEventListener('click', function() {
                        // Handle rejecting friend request
                        rejectFriendRequest(senderId, receiverId);
                    });

                    requestDiv.textContent = senderName + ' sent you a friend request.';
                    requestDiv.appendChild(acceptButton);
                    requestDiv.appendChild(rejectButton);

                    notificationContainer.appendChild(requestDiv);
                }
            });
        },
        error: function() {
            alert("Error fetching friend requests.");
        }
    });
}


    $('#notification').click(function() {
        $('#notificationModal').css('display', 'block');
        fetchFriendRequests();
        // alert("HELLO WORLD")
    });



    // Close the modal when clicking on the close button
    $('.close').click(function() {
        $('#notificationModal').css('display', 'none');
    });

    // Close the modal when clicking outside the modal
    $(window).click(function(event) {
        if (event.target.id === 'notificationModal') {
            $('#notificationModal').css('display', 'none');
        }
    });


    function acceptFriendRequest(senderId, receiverId, senderIdD) {
    $.ajax({
        url: "php/friendReqQuery.php",
        type: "POST",
        data: {
            senderId: senderId,
            senderIdD: senderIdD,
            receiverId: receiverId,
            status: 'Accepted'
        },
        success: function(data) {
            // Handle success response
            alert("Friend request accepted.");
            $('#notificationModal').css('display', 'none');
            window.location.reload();
        },
        error: function() {
            // Handle error response
            alert("Error accepting friend request.");
        }
    });
}

    function rejectFriendRequest(senderId, receiverId) {
        $.ajax({
        url: "php/friendReqQuery.php",
        type: "POST",
        data: {
            senderId: senderId,
            receiverId: receiverId,
            status: 'Rejected'
        },
        success: function(data) {
            // Handle success response
            alert("Friend request rejected.");
            $('#notificationModal').css('display', 'none');
            window.location.reload();
        },
        error: function() {
            // Handle error response
            alert("Error rejecting friend request.");
        }
    });
    }



// ||||||||||||||||||||||||||| COMMENT ||||||||||||||||||||||||||||||||||





});

document.querySelector('.post').addEventListener('click', ()=>{
    document.querySelector('.add-post').style.display = 'block';
})

document.querySelector('#close').addEventListener('click', ()=>{
    document.querySelector('.add-post').style.display = 'none';
})

$(document).ready(function() {
    let commentInput;

    $('.feeds-content').on('click', '#comment-btn', function() {
        commentInput = $(this).siblings('input[type="text"]');
        let commentText = commentInput.val().trim();
        let postId = $(this).closest('.post-container').find('#postId').val();
        let userId = localStorage.getItem("id");
        let friendId = $(this).closest('.post-container').find('#userId').val();

        if (commentText !== '') {
            addComment(userId, friendId, postId, commentText);
        }
    });

    // Function to add a comment
    function addComment(userId, friendId, postId, commentText) {
        $.ajax({
            url: "php/addComment.php",
            type: "POST",
            data: {
                user_id: userId,
                friend_id: friendId,
                postId: postId,
                comment: commentText
            },
            success: function(data) {
                let result = JSON.parse(data);
                if (result.res === "success") {
                    alert("Comment added successfully.");
                    // Clear the input field
                    commentInput.val('');
                } else {
                    alert(result.message);
                }
            },
            error: function() {
                alert("Error adding comment.");
            }
        });
    }
});








    </script>
</body>
</html>
